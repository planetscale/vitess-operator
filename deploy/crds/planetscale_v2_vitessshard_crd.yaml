apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: vitessshards.planetscale.com
spec:
  group: planetscale.com
  names:
    kind: VitessShard
    listKind: VitessShardList
    plural: vitessshards
    shortNames:
    - vts
    singular: vitessshard
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation
            of an object. Servers should convert recognized schemas to the latest
            internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this
            object represents. Servers may infer this from the endpoint the client
            submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds'
          type: string
        metadata:
          type: object
        spec:
          properties:
            backupEngine:
              description: BackupEngine specifies the Vitess backup engine to use,
                either "builtin" or "xtrabackup".
              type: string
            backupLocations:
              description: BackupLocations are the backup locations defined in the
                VitessCluster.
              items:
                properties:
                  gcs:
                    description: GCS specifies a backup location in Google Cloud Storage.
                    properties:
                      authSecret:
                        description: 'AuthSecret is a reference to the Secret to use
                          for GCS authentication. If set, this must point to a file
                          in the format expected for the GOOGLE_APPLICATION_CREDENTIALS
                          environment variable. Default: Use the default credentials
                          of the Node.'
                        type: object
                      bucket:
                        description: Bucket is the name of the GCS bucket to use.
                        minLength: 1
                        type: string
                      keyPrefix:
                        description: KeyPrefix is an optional prefix added to all
                          object keys created by Vitess. This is only needed if the
                          same bucket is also used for something other than backups
                          for VitessClusters. Backups from different clusters, keyspaces,
                          or shards will automatically avoid colliding with each other
                          within a bucket, regardless of this setting.
                        maxLength: 256
                        pattern: ^[^\r\n]*$
                        type: string
                    required:
                    - bucket
                    type: object
                  name:
                    description: Name is used to refer to this backup location from
                      other parts of a VitessCluster object, such as in tablet pool
                      definitions. This name must be unique among all backup locations
                      defined in a given cluster. A backup location with an empty
                      name defines the default location used when a tablet pool does
                      not specify a backup location name.
                    maxLength: 25
                    pattern: ^[a-z0-9]([a-z0-9]*[a-z0-9])?$
                    type: string
                  s3:
                    description: S3 specifies a backup location in Amazon S3.
                    properties:
                      authSecret:
                        description: 'AuthSecret is a reference to the Secret to use
                          for S3 authentication. If set, this must point to a file
                          in the format expected for the `~/.aws/credentials` file.
                          Default: Use the default credentials of the Node.'
                        type: object
                      bucket:
                        description: Bucket is the name of the S3 bucket to use.
                        minLength: 1
                        type: string
                      keyPrefix:
                        description: KeyPrefix is an optional prefix added to all
                          object keys created by Vitess. This is only needed if the
                          same bucket is also used for something other than backups
                          for VitessClusters. Backups from different clusters, keyspaces,
                          or shards will automatically avoid colliding with each other
                          within a bucket, regardless of this setting.
                        maxLength: 256
                        pattern: ^[^\r\n]*$
                        type: string
                      region:
                        description: Region is the AWS region in which the bucket
                          is located.
                        minLength: 1
                        type: string
                    required:
                    - region
                    - bucket
                    type: object
                  volume:
                    description: Volume specifies a backup location as a Kubernetes
                      Volume Source to mount. This can be used, for example, to store
                      backups on an NFS mount, or on a shared host path for local
                      testing.
                    type: object
                type: object
              type: array
            databaseInitScriptSecret:
              description: DatabaseInitScriptSecret specifies the init_db.sql script
                file to use for this shard. This SQL script file is executed immediately
                after bootstrapping an empty database to set up initial tables and
                other MySQL-level entities needed by Vitess.
              type: object
            extraVitessFlags:
              additionalProperties:
                type: string
              description: ExtraVitessFlags is inherited from the parent's VitessClusterSpec.
              type: object
            globalLockserver:
              description: GlobalLockserver are the params to connect to the global
                lockserver.
              properties:
                address:
                  description: Address is the host:port of the lockserver client endpoint.
                  type: string
                implementation:
                  description: Implementation specifies which Vitess "topo" plugin
                    to use.
                  type: string
                rootPath:
                  description: RootPath is a path prefix for all lockserver data belonging
                    to a given Vitess cluster. Multiple Vitess clusters can share
                    a lockserver as long as they have unique root paths.
                  type: string
              required:
              - implementation
              - address
              - rootPath
              type: object
            imagePullPolicies:
              description: ImagePullPolicies are inherited from the VitessCluster
                spec.
              properties:
                mysqld:
                  description: Mysqld is the container image pull policy to use for
                    mysqld.
                  type: string
                mysqldExporter:
                  description: MysqldExporter is the container image pull policy to
                    use for mysqld-exporter.
                  type: string
                vtbackup:
                  description: Vtbackup is the container image pull policy to use
                    for Vitess Backup jobs.
                  type: string
                vtctld:
                  description: Vtctld is the container image pull policy to use for
                    Vitess Dashboard instances.
                  type: string
                vtgate:
                  description: Vtgate is the container image pull policy to use for
                    Vitess Gateway instances.
                  type: string
                vttablet:
                  description: Vttablet is the container image pull policy to use
                    for Vitess Tablet instances.
                  type: string
              type: object
            images:
              description: Images are not customizable by users at the shard level
                because version skew across the shard is discouraged except during
                rolling updates, in which case this field is automatically managed
                by the VitessKeyspace controller that owns this VitessShard.
              properties:
                mysqld:
                  description: Mysqld specifies the container image to use for mysqld,
                    as well as declaring which MySQL flavor setting in Vitess the
                    image is compatible with. Only one flavor image may be provided
                    at a time. mysqld running alongside each tablet.
                  properties:
                    mariadb103Compatible:
                      description: Mariadb103Compatible is a container image (including
                        version tag) for mysqld that's compatible with the Vitess
                        "MariaDB103" flavor setting.
                      type: string
                    mariadbCompatible:
                      description: MariadbCompatible is a container image (including
                        version tag) for mysqld that's compatible with the Vitess
                        "MariaDB" flavor setting.
                      type: string
                    mysql56Compatible:
                      description: Mysql56Compatible is a container image (including
                        version tag) for mysqld that's compatible with the Vitess
                        "MySQL56" flavor setting.
                      type: string
                    mysql80Compatible:
                      description: Mysql80Compatible is a container image (including
                        version tag) for mysqld that's compatible with the Vitess
                        "MySQL80" flavor setting.
                      type: string
                  type: object
                mysqldExporter:
                  description: MysqldExporter specifies the container image for mysqld-exporter.
                  type: string
                vtbackup:
                  description: Vtbackup is the container image (including version
                    tag) to use for Vitess Backup jobs.
                  type: string
                vttablet:
                  description: Vttablet is the container image (including version
                    tag) to use for Vitess Tablet instances.
                  type: string
              type: object
            keyRange:
              description: KeyRange is the range of keyspace IDs served by this shard.
              properties:
                end:
                  description: End is a lowercase hexadecimal string representation
                    of an arbitrary-length sequence of bytes. If End is the empty
                    string, the key range is unbounded at the top. If End is not empty,
                    the bytes of a keyspace ID must compare strictly less than End
                    in lexicographical order to be in the range.
                  pattern: ^([0-9a-f][0-9a-f])*$
                  type: string
                start:
                  description: Start is a lowercase hexadecimal string representation
                    of an arbitrary-length sequence of bytes. If Start is the empty
                    string, the key range is unbounded at the bottom. If Start is
                    not empty, the bytes of a keyspace ID must compare greater than
                    or equal to Start in lexicographical order to be in the range.
                  pattern: ^([0-9a-f][0-9a-f])*$
                  type: string
              type: object
            name:
              description: Name is the shard name as its known to Vitess.
              type: string
            replication:
              description: Replication configures Vitess replication settings for
                the shard.
              properties:
                enforceSemiSync:
                  description: 'EnforceSemiSync means Vitess will configure MySQL
                    to require semi-sync acknowledgement of all transactions while
                    forbidding fallback to asynchronous replication under any circumstance.  Note
                    that this is different from merely *enabling* semi-sync, which
                    in its default configuration allows fallback to asynchronous replication
                    if no replicas are connected or if they don''t respond after a
                    few seconds. Enforced semi-sync is a mode that prefers master
                    unavailability when durability cannot be ensured, rather than
                    risking the loss of data that was already reported to clients
                    as committed.  WARNING: Do not enable this if the shard has fewer
                    than 3 master-eligible replicas, as that may lead to master unavailability
                    during routine maintenance.  Default: Semi-sync is not enforced.'
                  type: boolean
              type: object
            tabletPools:
              description: TabletPools specify groups of tablets in a given cell with
                a certain tablet type and a shared configuration template.  There
                must be at most one pool in this list for each (cell,type) pair. Each
                shard must have at least one "replica" pool (in at least one cell)
                in order to be able to serve. +patchMergeKey=type +patchStrategy=merge
                +listType=map +listMapKey=type +listMapKey=cell
              items:
                properties:
                  affinity:
                    description: 'Affinity allows you to set rules that constrain
                      the scheduling of your vttablet pods. Affinity rules will affect
                      all underlying tablets in the specified tablet pool the same
                      way. WARNING: These affinity rules will override all default
                      affinities that we set; in turn, we can''t guarantee optimal
                      scheduling of your pods if you choose to set this field.'
                    type: object
                  annotations:
                    additionalProperties:
                      type: string
                    description: Annotations can optionally be used to attach custom
                      annotations to Pods created for this component.
                    type: object
                  backupLocationName:
                    description: 'BackupLocationName is the name of the backup location
                      to use for this tablet pool. It must match the name of one of
                      the backup locations defined in the VitessCluster. Default:
                      Use the backup location whose name is empty.'
                    type: string
                  cell:
                    description: Cell is the name of the Vitess cell in which to deploy
                      this pool.
                    minLength: 1
                    pattern: ^[a-z0-9]([a-z0-9]*[a-z0-9])?$
                    type: string
                  dataVolumeClaimTemplate:
                    description: 'DataVolumeClaimTemplate configures the PersistentVolumeClaims
                      that will be created for each tablet to store its database files.
                      This field is required for local MySQL, but should be omitted
                      in the case of externally managed MySQL.  IMPORTANT: If your
                      Kubernetes cluster is multi-zone, you must set a storageClassName
                      here for a StorageClass that''s configured to only provision
                      volumes in the same zone as this tablet pool.'
                    type: object
                  externalDatastore:
                    description: ExternalDatastore provides information for an externally
                      managed MySQL. You must specify either Mysqld or ExternalDatastore,
                      but not both.
                    properties:
                      credentialsSecret:
                        description: 'CredentialsSecret should link to a JSON credentials
                          file used to connect to the externally managed MySQL endpoint.
                          The credentials file is understood and parsed by Vitess
                          and must be in the format: {   "username": [     "password"   ]
                          } Vitess always uses the first password in the password
                          array.'
                        type: object
                      database:
                        description: Database is the name of the database.
                        type: string
                      host:
                        description: Host is the endpoint string to an externally
                          managed MySQL, without any port.
                        type: string
                      port:
                        description: Port specifies the port for the externally managed
                          MySQL endpoint.
                        format: int32
                        maximum: 65535
                        minimum: 1
                        type: integer
                      serverCACertSecret:
                        description: ServerCACertSecret should link to a certificate
                          authority file if one is required by your externally managed
                          MySQL endpoint.
                        type: object
                      user:
                        description: User is a provided database user from an externally
                          managed MySQL that Vitess can use to carry out necessary
                          actions.  Password for this user must be supplied in the
                          CredentialsSecret.
                        type: string
                    required:
                    - user
                    - host
                    - port
                    - database
                    - credentialsSecret
                    type: object
                  extraEnv:
                    description: ExtraEnv can optionally be used to override default
                      environment variables set by the operator, or pass additional
                      environment variables. These values are applied to both the
                      vttablet and mysqld containers.
                    items:
                      type: object
                    type: array
                  extraVolumeMounts:
                    description: ExtraVolumeMounts can optionally be used to override
                      default Pod volumeMounts defined by the operator, or specify
                      additional mounts. Typically, these are used to mount volumes
                      defined through extraVolumes. These values are applied to both
                      the vttablet and mysqld containers.
                    items:
                      type: object
                    type: array
                  extraVolumes:
                    description: ExtraVolumes can optionally be used to override default
                      Pod volumes defined by the operator, or provide additional volumes
                      to the Pod. Note that when adding a new volume, you should usually
                      also add a volumeMount to specify where in each container's
                      filesystem the volume should be mounted. These volumes are available
                      to be mounted by both vttablet and mysqld.
                    items:
                      type: object
                    type: array
                  mysqld:
                    description: Mysqld configures a local MySQL running inside each
                      tablet Pod. You must specify either Mysqld or ExternalDatastore,
                      but not both.
                    properties:
                      configOverrides:
                        description: ConfigOverrides can optionally be used to provide
                          a my.cnf snippet to override default my.cnf values (included
                          with Vitess) for this particular MySQL instance.
                        type: string
                      resources:
                        description: Resources specify the compute resources to allocate
                          for just the MySQL process (the underlying local datastore).
                          This field is required.
                        type: object
                    required:
                    - resources
                    type: object
                  replicas:
                    description: Replicas is the number of tablets to deploy in this
                      pool. This field is required, although it may be set to 0, which
                      will scale the pool down to 0 tablets.
                    format: int32
                    minimum: 0
                    type: integer
                  type:
                    description: Type is the type of tablet contained in this tablet
                      pool. The allowed types are "replica" for master-eligible replicas
                      that serve transactional (OLTP) workloads; and "rdonly" for
                      master-ineligible replicas (can never be promoted to master)
                      that serve batch/analytical (OLAP) workloads.
                    enum:
                    - replica
                    - rdonly
                    - externalmaster
                    - externalreplica
                    - externalrdonly
                    type: string
                  vttablet:
                    description: Vttablet configures the vttablet server within each
                      tablet.
                    properties:
                      extraFlags:
                        additionalProperties:
                          type: string
                        description: 'ExtraFlags can optionally be used to override
                          default flags set by the operator, or pass additional flags
                          to vttablet. All entries must be key-value string pairs
                          of the form "flag": "value". The flag name should not have
                          any prefix (just "flag", not "-flag"). To set a boolean
                          flag, set the string value to either "true" or "false".'
                        type: object
                      resources:
                        description: Resources specify the compute resources to allocate
                          for just the vttablet process (the Vitess query server that
                          sits in front of MySQL). This field is required.
                        type: object
                    required:
                    - resources
                    type: object
                required:
                - cell
                - type
                - replicas
                - vttablet
                type: object
              type: array
            zoneMap:
              additionalProperties:
                type: string
              description: ZoneMap is a map from Vitess cell name to zone (failure
                domain) name for all cells defined in the VitessCluster.
              type: object
          required:
          - name
          - zoneMap
          - images
          - keyRange
          - globalLockserver
          type: object
        status:
          properties:
            backupLocations:
              description: BackupLocations reports information about the backups for
                this shard in each backup location.
              items:
                properties:
                  completeBackups:
                    description: CompleteBackups is the number of complete backups
                      observed.
                    format: int32
                    type: integer
                  incompleteBackups:
                    description: IncompleteBackups is the number of incomplete backups
                      observed.
                    format: int32
                    type: integer
                  latestCompleteBackupTime:
                    description: LatestCompleteBackupTime is the timestamp of the
                      most recent complete backup.
                    format: date-time
                    type: string
                  name:
                    description: Name is the backup location name.
                    type: string
                required:
                - completeBackups
                - incompleteBackups
                type: object
              type: array
            cells:
              description: Cells is a list of cells in which any tablets for this
                shard are deployed.
              items:
                type: string
              type: array
            hasInitialBackup:
              description: HasInitialBackup is a condition indicating whether the
                initial backup has been seeded for the shard.
              type: string
            hasMaster:
              description: HasMaster is a condition indicating whether the Vitess
                topology reflects a master for this shard.
              type: string
            idle:
              description: Idle is a condition indicating whether the shard can be
                turned down. If Idle is True, the shard is not part of the active
                shard set (partitioning) for any tablet type in any cell, so it should
                be safe to turn down the shard.
              type: string
            masterAlias:
              description: MasterAlias is the tablet alias of the master according
                to the global shard record. This could be empty either because there
                is no master, or because the shard record could not be read. Check
                the HasMaster condition whenever the distinction is important.
              type: string
            observedGeneration:
              description: The generation observed by the controller.
              format: int64
              type: integer
            orphanedTablets:
              additionalProperties:
                properties:
                  message:
                    description: Message is a human-readable explanation for why the
                      object is orphaned.
                    type: string
                  reason:
                    description: Reason is a CamelCase token for programmatic reasoning
                      about why the object is orphaned.
                    type: string
                required:
                - reason
                - message
                type: object
              description: OrphanedTablets is a list of unwanted tablets that could
                not be turned down.
              type: object
            tablets:
              additionalProperties:
                properties:
                  available:
                    description: Available indicates whether the vttablet Pod has
                      been consistently Ready for long enough to be considered stable.
                    type: string
                  dataVolumeBound:
                    description: DataVolumeBound indicates whether the main PersistentVolumeClaim
                      has been matched up with a PersistentVolume and bound to it.
                    type: string
                  index:
                    description: Index is the tablet's index within its tablet pool.
                    format: int32
                    type: integer
                  pendingChanges:
                    description: PendingChanges describes changes to the tablet Pod
                      that will be applied the next time a rolling update allows.
                    type: string
                  poolType:
                    description: PoolType is the target tablet type for the tablet
                      pool.
                    type: string
                  ready:
                    description: Ready indicates whether the vttablet Pod is passing
                      health checks, meaning it's ready to serve queries.
                    type: string
                  running:
                    description: Running indicates whether the vttablet Pod is running.
                    type: string
                  type:
                    description: Type is the observed tablet type as reflected in
                      topology.
                    type: string
                type: object
              description: Tablets is a summary of the status of all desired tablets
                in the shard.
              type: object
          type: object
  version: v2
  versions:
  - name: v2
    served: true
    storage: true
